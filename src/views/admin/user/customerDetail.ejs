<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MIRA - Whiskas Dry Adult Dewasa 7+</title>
    <link rel="stylesheet" href="/admin/css/style.css" />
    <link rel="stylesheet" href="/admin/css/users/detailUser.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
        integrity="sha512-2SwdPD6INVr   V/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png" />
</head>

<body>
    <div class="container">
        <%- include('../layout/sidebar.ejs'); -%>

            <%- include('../layout/header.ejs'); -%>
                <!-- Main Content -->


                <main class="main-content">
                    <h2 style="margin-bottom: 20px;">Chi ti·∫øt kh√°ch h√†ng</h2>
                    <div class="container_detail">
                        <!-- Header -->
                        <div class="header_detail">
                            <div class="header-content">

                                <img src="<%= user.avatar ? '/images/users/' + user.avatar : '/images/users/avatar-face.jpg' %>"
                                    alt="Customer Avatar" class="customer-avatar" id="customerAvatar">

                                <div class="customer-info">
                                    <h1 id="customerName">
                                        <%= user.username %>
                                    </h1>
                                    <p id="customerEmail">üìß <%= user.email %>
                                    </p>
                                    <p id="customerPhone">üì± <%= user.phone %>
                                    </p>
                                    <p id="customerJoinDate">
                                        üìÖ <%= user.birthday ? user.birthday.toLocaleDateString("vi-VN") : "" %>
                                    </p>
                                </div>
                                <div class="actions">

                                    <button class="btn btn-primary" onclick="goBack()">
                                        ‚Üê Quay l·∫°i
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Content -->
                        <div class="content">
                            <!-- Tabs -->
                            <div class="tabs">
                                <div class="tab active" onclick="switchTab('info')">Th√¥ng tin c∆° b·∫£n</div>
                                <div class="tab" onclick="switchTab('orders')">L·ªãch s·ª≠ ƒë∆°n h√†ng</div>
                                <div class="tab" onclick="switchTab('loyalty')">ƒêi·ªÉm th∆∞·ªüng</div>
                            </div>

                            <!-- Tab Content -->
                            <div id="info" class="tab-content active">
                                <div class="info-grid">
                                    <div class="info-card">
                                        <h3>üè† Th√¥ng tin c√° nh√¢n</h3>
                                        <div class="info-item">
                                            <span class="info-label">H·ªç v√† t√™n:</span>
                                            <span class="info-value">
                                                <%= user.username %>
                                            </span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">Gi·ªõi t√≠nh:</span>
                                            <span class="info-value">
                                                <%= user.gender %>
                                            </span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">Ng√†y sinh:</span>
                                            <span class="info-value">
                                                <%= user.birthday ? user.birthday.toLocaleDateString("vi-VN") : "" %>
                                            </span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">ƒê·ªãa ch·ªâ:</span>
                                            <span class="info-value">
                                                <%= user.address %>
                                            </span>
                                        </div>
                                    </div>

                                    <div class="info-card">
                                        <h3>üìä Th·ªëng k√™ t√†i kho·∫£n</h3>
                                        <div class="info-item">
                                            <span class="info-label">T·ªïng ƒë∆°n h√†ng:</span>
                                            <span class="info-value">
                                                <%= user.orders.length %> ƒë∆°n
                                            </span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">T·ªïng chi ti√™u:</span>
                                            <span class="info-value">
                                                <% const total=user.orders.reduce((sum, order)=> sum +
                                                    order.total_amount, 0);
                                                    %>

                                                    <%= new Intl.NumberFormat('vi-VN', { style: 'currency' ,
                                                        currency: 'VND' }).format(total) %>
                                            </span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">ƒê∆°n h√†ng trung b√¨nh:</span>
                                            <span class="info-value">
                                                <% const totalCount=user.orders.reduce((sum, order)=> sum +
                                                    order.total_amount, 0);
                                                    const totalAvg = totalCount / user.orders.length;
                                                    %>
                                                    <%= new Intl.NumberFormat('vi-VN', { style: 'currency' ,
                                                        currency: 'VND' }).format(totalAvg) %>
                                            </span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">L·∫ßn mua cu·ªëi:</span>
                                            <span class="info-value">
                                                <% let last=null; if (user.orders && user.orders.length> 0) {
                                                    last = user.orders[user.orders.length - 1].orderDate;
                                                    }
                                                    %>
                                                    <%= last ? new Date(last).toLocaleDateString("vi-VN") : "" %>
                                            </span>
                                        </div>
                                    </div>



                                </div>
                            </div>

                            <div id="orders" class="tab-content">
                                <table class="orders-table">
                                    <thead>
                                        <tr>
                                            <th>M√£ ƒë∆°n</th>
                                            <th>Ng√†y ƒë·∫∑t</th>
                                            <th>S·∫£n ph·∫©m</th>
                                            <th>T·ªïng ti·ªÅn</th>
                                            <th>Tr·∫°ng th√°i</th>
                                            <th>Thao t√°c</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% user.orders.forEach(order=> { %>
                                            <% order.order_details.forEach(detail=> { %>
                                                <tr>
                                                    <td>#<%= "MD" + order.order_id.toString().padStart(3, '0' ) %>
                                                    </td>
                                                    <td>
                                                        <%= new Date(order.orderDate).toLocaleDateString("vi-VN") %>
                                                    </td>
                                                    <td>
                                                        <%= detail.products.name %> x<%= detail.quantity %>
                                                    </td>
                                                    <td>
                                                        <%= new Intl.NumberFormat("vi-VN", { style: "currency" ,
                                                            currency: "VND" }).format(detail.price * detail.quantity) %>
                                                    </td>
                                                    <td><span class="order-status status-<%= order.status %>">
                                                            <%= order.status %>
                                                        </span></td>
                                                    <td>
                                                        <button class="btn"
                                                            style="padding: 8px 16px; font-size: 0.9rem;">
                                                            Xem chi ti·∫øt
                                                        </button>
                                                    </td>
                                                </tr>
                                                <% }) %>
                                                    <% }) %>
                                    </tbody>

                                </table>
                            </div>

                            <div id="loyalty" class="tab-content">
                                <div class="info-grid">
                                    <div class="info-card">
                                        <h3>üèÜ ƒêi·ªÉm th∆∞·ªüng hi·ªán t·∫°i</h3>

                                        <% user.point_history.forEach((point)=> { %>
                                            <div class="info-item">
                                                <span class="info-label">ƒêi·ªÉm t√≠ch l≈©y:</span>
                                                <span class="info-value">
                                                    <%= user.point %> ƒëi·ªÉm
                                                </span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">H·∫°ng th√†nh vi√™n:</span>
                                                <span class="info-value">V√†ng</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">∆Øu ƒë√£i hi·ªán t·∫°i:</span>
                                                <span class="info-value">Ch∆∞a c√≥</span>
                                            </div>
                                            <% }); %>
                                    </div>

                                    <div class="info-card">
                                        <h3>üìà L·ªãch s·ª≠ ƒëi·ªÉm</h3>
                                        <% user.point_history.forEach((point)=> { %>
                                            <div class="info-item">
                                                <span class="info-label">
                                                    <%= new Date(point.created_at).toLocaleDateString("vi-VN") %>
                                                </span>
                                                <span class="info-value">+ <%= point.change %> ƒëi·ªÉm</span>
                                            </div>
                                            <% }); %>

                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>


                </main>
    </div>

    <script src="/admin/js/users/user-detail.js"></script>
</body>

</html>