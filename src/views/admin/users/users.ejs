<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>MIRA - Whiskas Dry Adult Dewasa 7+</title>
        <link rel="stylesheet" href="/admin/css/style.css" />
        <link rel="stylesheet" href="/admin/css/users/user.css" />
        <link rel="stylesheet" href="/admin/css/users/addUser.css" />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            href="/images/favicon/favicon-32x32.png"
        />

        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
            integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        />
    </head>

    <body>
        <div class="container">
            <%- include('../layout/sidebar.ejs'); -%>

            <!-- Main Content -->
            <main class="main-content">
                <%- include('create_user.ejs', { roles: roles }); -%>

                <!-- Stats Section -->
                <h1 class="title">Quản lý tài khoản</h1>
                <section class="stats-section">
                    <div class="stat-card red">
                        <div class="stat-header">
                            <div class="stat-title">Tổng khách hàng</div>
                            <div class="stat-icon" style="background: #e53e3e">
                                <i class="fa-solid fa-user"></i>
                            </div>
                        </div>
                        <div class="stat-value">1,247</div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            +12 từ tháng trước
                        </div>
                    </div>

                    <div class="stat-card blue">
                        <div class="stat-header">
                            <div class="stat-title">Khách hàng VIP</div>
                            <div class="stat-icon" style="background: #3182ce">
                                <i class="fas fa-crown"></i>
                            </div>
                        </div>
                        <div class="stat-value">89</div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            +5 VIP mới
                        </div>
                    </div>

                    <div class="stat-card orange">
                        <div class="stat-header">
                            <div class="stat-title">Đơn hàng tháng này</div>
                            <div class="stat-icon" style="background: #dd6b20">
                                <i class="fas fa-shopping-bag"></i>
                            </div>
                        </div>
                        <div class="stat-value">3,456</div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            +18% so với tháng trước
                        </div>
                    </div>
                </section>

                <!-- Filters Section -->
                <section class="filters-section">
                    <div class="filters-section_header">
                        <div class="filters-header">
                            <h3>Bộ lọc và tìm kiếm</h3>
                            <p>Tìm kiếm và lọc khách hàng theo các tiêu chí</p>
                        </div>
                    </div>

                    <div class="filters-row">
                        <div class="filter-group">
                            <label>Tìm kiếm</label>
                            <div class="search-wrapper">
                                <i class="fa-solid fa-magnifying-glass"></i>
                                <input
                                    type="text"
                                    class="search-input"
                                    placeholder="Tìm kiếm theo tên, email hoặc số điện thoại..."
                                />

                                <div class="search-member">
                                    <button class="btn btn-primary">
                                        Tìm kiếm
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label>Vai trò</label>
                            <select class="filter-select">
                                <option>Tất cả vai trò</option>
                                <option>Khách hàng</option>
                                <option>VIP</option>
                                <option>Nhân viên</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Trạng thái</label>
                            <select class="filter-select">
                                <option>Tất cả trạng thái</option>
                                <option>Hoạt động</option>
                                <option>Bị khóa</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Ngày tham gia</label>
                            <select class="filter-select">
                                <option>Tất cả thời gian</option>
                                <option>7 ngày qua</option>
                                <option>30 ngày qua</option>
                                <option>3 tháng qua</option>
                            </select>
                        </div>

                        <div class="filter-member">
                            <button class="btn btn-primary">Lọc</button>
                        </div>
                    </div>
                </section>

                <!-- Customer Table -->
                <section class="table-section">
                    <div class="table-header">
                        <h3 class="table-title">Danh sách khách hàng</h3>
                        <div style="display: flex; gap: 10px">
                            <button class="btn btn-secondary">
                                <i class="fas fa-download"></i>
                                Xuất Excel
                            </button>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table class="customer-table">
                            <thead>
                                <tr>
                                    <th>Tên</th>
                                    <th>email</th>
                                    <th>Vai trò</th>
                                    <th>Giới tính</th>
                                    <th>Tổng chi tiêu</th>
                                    <th>Đơn hàng</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>

                            <tbody id="customerTableBody">
                                <% users.forEach(function (user) { %>
                                <tr
                                    onclick="window.location= '/admin/user/customer-detail/<%= user.user_id %>'"
                                    style="cursor: pointer"
                                >
                                    <td><%= user.username %></td>
                                    <td><%= user.email %></td>
                                    <td>
                                        <span class="role-badge admin"
                                            >Customer</span
                                        >
                                    </td>
                                    <td><%= user.gender %></td>

                                    <td>
                                        <% const total=user.orders.reduce((sum,
                                        order)=> sum + order.total_amount, 0);
                                        %> <%= new Intl.NumberFormat('vi-VN', {
                                        style: 'currency' , currency: 'VND'
                                        }).format(total) %>
                                    </td>
                                    <td><%= user.orders.length %></td>

                                    <td>
                                        <div
                                            style="
                                                display: flex;
                                                gap: 20px;
                                                position: relative;
                                                left: 30px;
                                            "
                                        >
                                            <% if (user.status==="ACTIVE" ) { %>
                                            <form
                                                action="/admin/lock-user/<%= user.user_id %>"
                                                method="post"
                                            >
                                                <button
                                                    type="submit"
                                                    class="btn btn-warning btn-lock"
                                                >
                                                    Khóa
                                                </button>
                                            </form>
                                            <% } else { %>
                                            <form
                                                action="/admin/unlock-user/<%= user.user_id %>"
                                                method="post"
                                            >
                                                <button
                                                    type="submit"
                                                    class="btn btn-success btn-unlock"
                                                >
                                                    Mở khóa
                                                </button>
                                            </form>
                                            <% } %>
                                            <form
                                                action="/admin/delete-user/<%= user.user_id %>"
                                                method="post"
                                            >
                                                <button
                                                    type="submit"
                                                    class="btn btn-danger"
                                                >
                                                    Xóa
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <ul class="pagination">
                        <li>
                            <a
                                class="<%= pageCustomer === 1 || totalPagesCustomer === 1 ? 'disabled' : '' %>"
                                href="/admin/user?pageCustomer=<%= pageCustomer - 1 %>"
                                >&laquo; Prev</a
                            >
                        </li>

                        <% for(let i=1; i <=totalPagesCustomer; i++) { %>
                        <li>
                            <a
                                class="<%= pageCustomer === i ? 'active' : '' %>"
                                href="/admin/user?pageCustomer=<%= i %>"
                            >
                                <%= i %>
                            </a>
                        </li>
                        <% } %>

                        <li>
                            <a
                                class="<%= pageCustomer === totalPagesCustomer || totalPagesCustomer === 1 ? 'disabled' : '' %>"
                                href="/admin/user?pageCustomer=<%= pageCustomer + 1 %>"
                                >Next &raquo;</a
                            >
                        </li>
                    </ul>
                </section>

                <!-- staff Table -->
                <section class="table-section">
                    <div class="table-header">
                        <h3 class="table-title">Danh sách nhân viên</h3>
                        <div style="display: flex; gap: 10px">
                            <button class="btn btn-secondary">
                                <i class="fas fa-download"></i>
                                Xuất Excel
                            </button>

                            <div class="filter-group">
                                <button
                                    class="btn btn-primary"
                                    onclick="openAddModal()"
                                >
                                    <i class="fas fa-plus"></i>
                                    Thêm tài khoản
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table class="customer-table">
                            <thead>
                                <tr>
                                    <th>Tên</th>
                                    <th>email</th>
                                    <th>Vai trò</th>
                                    <th>Giới tính</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>

                            <tbody id="staffTableBody">
                                <% staffs.forEach(function (staff) { %>
                                <tr
                                    onclick="window.location= '/admin/user/staff-detail/<%= staff.user_id %>'"
                                    style="cursor: pointer"
                                >
                                    <td><%= staff.username %></td>
                                    <td><%= staff.email %></td>
                                    <td>
                                        <% if(staff.roles.name==="ADMIN" ) { %>
                                        <span class="role-badge admin"
                                            >Admin</span
                                        >
                                        <% } else { %>
                                        <span class="role-badge staff"
                                            >Staff</span
                                        >
                                        <% } %>
                                    </td>
                                    <td><%= staff.gender %></td>
                                    <td>
                                        <div
                                            style="
                                                display: flex;
                                                gap: 20px;
                                                position: relative;
                                                left: 100px;
                                            "
                                        >
                                            <% if (staff.status==="ACTIVE" ) {
                                            %>
                                            <form
                                                action="/admin/lock-user/<%= staff.user_id %>"
                                                method="post"
                                            >
                                                <button
                                                    type="submit"
                                                    class="btn btn-warning btn-lock"
                                                >
                                                    Khóa
                                                </button>
                                            </form>
                                            <% } else { %>
                                            <form
                                                action="/admin/unlock-user/<%= staff.user_id %>"
                                                method="post"
                                            >
                                                <button
                                                    type="submit"
                                                    class="btn btn-success btn-unlock"
                                                >
                                                    Mở khóa
                                                </button>
                                            </form>
                                            <% } %>
                                            <form
                                                action="/admin/delete-user/<%= staff.user_id %>"
                                                method="post"
                                            >
                                                <button
                                                    type="submit"
                                                    class="btn btn-danger"
                                                >
                                                    Xóa
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <ul class="pagination">
                        <li>
                            <a
                                class="<%= pageStaff === 1 || totalPagesStaff === 1 ? 'disabled' : '' %>"
                                href="/admin/user?pageStaff=<%= pageStaff - 1 %>"
                                >&laquo; Prev</a
                            >
                        </li>

                        <% for(let i=1; i <=totalPagesStaff; i++) { %>
                        <li>
                            <a
                                class="<%= pageStaff === i ? 'active' : '' %>"
                                href="/admin/user?pageStaff=<%= i %>"
                            >
                                <%= i %>
                            </a>
                        </li>
                        <% } %>

                        <li>
                            <a
                                class="<%= pageStaff === totalPagesStaff || totalPagesStaff === 1 ? 'disabled' : '' %>"
                                href="/admin/user?pageStaff=<%= pageStaff + 1 %>"
                                >Next &raquo;</a
                            >
                        </li>
                    </ul>
                </section>
            </main>
        </div>
        <script src="/admin/js/users/users.js"></script>
    </body>
</html>
