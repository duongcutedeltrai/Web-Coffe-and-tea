// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model cart {
  cart_id      Int            @id @default(autoincrement())
  user_id      Int
  total        Decimal        @db.Decimal(10, 2)
  quantity     Int
  users        users          @relation(fields: [user_id], references: [user_id], onDelete: NoAction, onUpdate: NoAction, map: "cart_ibfk_1")
  cart_details cart_details[]

  @@index([user_id], map: "user_id")
}

model cart_details {
  cart_detail_id Int      @id @default(autoincrement())
  cart_id        Int
  product_id     Int
  quantity       Int

  price          Decimal  @db.Decimal(10, 2)
  cart           cart     @relation(fields: [cart_id], references: [cart_id], onDelete: NoAction, onUpdate: NoAction, map: "cart_details_ibfk_1")
  products       products @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction, map: "cart_details_ibfk_2")

  @@index([cart_id], map: "cart_id")
  @@index([product_id], map: "product_id")
}

model categories {
  category_id Int        @id @default(autoincrement())
  name        String     @db.VarChar(100)
  description String?    @db.VarChar(255)
  images             String?               @db.VarChar(255)
  products    products[]
  created_at   DateTime?  @default(now()) @db.DateTime(0)
  deleted_at  DateTime? 


}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model feedback {
  id         Int      @id @default(autoincrement())
  user_id    Int
  product_id Int
  created_at DateTime @default(now()) @db.DateTime(0)
  rating     Int
  comment    String?  @db.VarChar(255)
  users      users    @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction, map: "feedback_ibfk_1")

  products   products @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction, map: "feedback_ibfk_2")

  @@index([product_id], map: "product_id")
  @@index([user_id], map: "user_id")
}

model inventory {
  inventory_id Int                   @id @default(autoincrement())
  product_id   Int
  change_type  inventory_change_type
  quantity     Int
  created_at   DateTime              @default(now()) @db.DateTime(0)
  products     products              @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction, map: "inventory_ibfk_1")

  @@index([product_id], map: "product_id")
}

model order_details {
  order_detail_id Int      @id @default(autoincrement())
  order_id        String
  product_id      Int
  quantity        Int
   size            String?  @db.VarChar(20)
  price           Decimal  @db.Decimal(10, 2)
  orders          orders   @relation(fields: [order_id], references: [order_id], onDelete: NoAction, onUpdate: NoAction, map: "order_details_ibfk_1")
  products        products @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction, map: "order_details_ibfk_2")

  @@index([order_id], map: "order_id")
  @@index([product_id], map: "product_id")
}

model order_status_history {
  order_status_history_id Int                         @id @default(autoincrement())
  order_id                String                      @db.VarChar(50)
  status                  order_status_history_status
  changed_at              DateTime                    @default(now()) @db.DateTime(0)
  orders                  orders                      @relation(fields: [order_id], references: [order_id], onDelete: NoAction, onUpdate: NoAction, map: "order_status_history_ibfk_1")

  @@index([order_id], map: "order_id")
}

model orders {
  order_id             String                  @id @db.VarChar(50)
  user_id              Int?
  orderDate            DateTime               @default(now()) @db.DateTime(0)
  status               orders_status          @default(pending)
  delivery_address     String                 @db.VarChar(255)
  receiver_name        String                 @db.VarChar(100)
  receiver_phone       String                 @db.VarChar(20)
  order_details        order_details[]
  order_status_history order_status_history[]
  users                users?                 @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction, map: "orders_ibfk_1")

  payment              payment[]
  order_type           OrderType              @default(DINE_IN)
  order_source         OrderSource            @default(STAFF)

  promotion_id       String?
  original_amount    Decimal              @db.Decimal(10, 2)  // Giá gốc
  discount_amount    Decimal              @default(0)         @db.Decimal(10, 2) // Tiền giảm
  final_amount       Decimal              @db.Decimal(10, 2)  // Giá cuối = original - discount
  @@index([user_id], map: "user_id")
  promotion_usage    promotion_usage[]
}

model payment {
  payment_id       Int            @id @default(autoincrement())
  order_id         String         @db.VarChar(50)
  method           payment_method
  status           payment_status @default(pending)
  total_amount     Int
  transaction_date DateTime       @default(now()) @db.DateTime(0)
  orders           orders         @relation(fields: [order_id], references: [order_id], onDelete: NoAction, onUpdate: NoAction, map: "payment_ibfk_1")

  @@index([order_id], map: "order_id")
}

model products {
  product_id         Int                  @id @default(autoincrement())
  name               String               @db.VarChar(255)
  description        String?              @db.VarChar(255)

  sold               Int                  @default(0)
  category_id        Int?
  images             String?               @db.VarChar(255)
  quantity           Int                  @default(-1)

  //price              Decimal              @db.Decimal(10, 2)
  cart_details       cart_details[]
  feedback           feedback[]
  inventory          inventory[]
  order_details      order_details[]
  categories         categories?          @relation(fields: [category_id], references: [category_id], onDelete: NoAction, onUpdate: NoAction, map: "products_ibfk_1")
  promotion_products promotion_products[]
  price_product      price_product[]


  @@index([category_id], map: "category_id")
}

model price_product {
  price_product_id Int          @id @default(autoincrement())
  product_id       Int
  size             product_size?
  price            Int

  products products @relation(fields: [product_id], references: [product_id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([product_id, size], map: "product_size_unique")
  @@index([product_id], map: "product_id_idx")
}


model promotion_products {
  promotion_product_id String        @id @default(uuid())
  promotion_id         String
  product_id           Int
  size                 String?    @db.VarChar(10)
  promotions           promotions @relation(fields: [promotion_id], references: [promotion_id], onDelete: NoAction, onUpdate: NoAction, map: "promotion_products_ibfk_1")
  products             products   @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction, map: "promotion_products_ibfk_2")

  @@index([product_id], map: "product_id")
  @@index([promotion_id], map: "promotion_id")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model promotions {
  promotion_id       String                  @id 
  code               String               @unique(map: "code") @db.VarChar(50)
  description        String?              @db.VarChar(255)
  discount_percent   Decimal              @db.Decimal(5, 2)
  start_date         DateTime             @db.Date
  end_date           DateTime             @db.Date

  //Điều kiện áp dụng
  min_order_amount   Decimal?             @db.Decimal(10, 2)  // Đơn tối thiểu
  max_usage_count    Int?                 // Số lần dùng giới hạn (null = không giới hạn)
  current_usage      Int                  @default(0)        // Đã dùng bao nhiêu lần
  is_for_new_user    Boolean              @default(false)    // Chỉ dùng cho KH mới?
  applicable_membership Json? 

  is_active          Boolean              @default(true) 

  promotion_products promotion_products[]
  promotion_usage    promotion_usage[] 
}

model promotion_usage {
  usage_id     Int         @id @default(autoincrement())
  promotion_id String
  order_id     String
  user_id      Int?
  user_phone   String?     @db.VarChar(20)
  used_at      DateTime    @default(now()) @db.DateTime(0)
  
  promotions   promotions  @relation(fields: [promotion_id], references: [promotion_id], onDelete: NoAction)
  orders       orders      @relation(fields: [order_id], references: [order_id], onDelete: NoAction)
  users        users?      @relation("UserPromotionUsage", fields: [user_id], references: [user_id], onDelete: NoAction)
  
  @@index([promotion_id])
  @@index([order_id])
  @@index([user_id])
  @@unique([promotion_id, user_id])  
}

model roles {
  role_id     Int     @id @default(autoincrement())
  name        String  @db.VarChar(50)
  description String  @db.VarChar(255)
  users       users[]
}

model users {
 user_id  Int         @id @default(autoincrement())
  email    String      @unique(map: "email") @db.VarChar(255)
  username String      @db.VarChar(255)
  password String      @db.VarChar(255)
  phone    String?      @db.VarChar(255) @unique(map: "phone")
  address  String?     @db.VarChar(255)
  avatar   String?     @db.VarChar(255)
  gender   String?     @db.VarChar(45)
  birthday DateTime?
  status   user_status @default(ACTIVE)
  point    Int?        @default(0)
  role_id       Int
  reset_token   String?               @db.VarChar(255)
  reset_token_expire  DateTime?              @db.DateTime(0)
  auth_provider users_auth_provider? @default(system)
   membership    membership_level?
  discount_rate Int?              @default(0)
  cart          cart[]
   point_history point_history[]
  staff_detail  staff_detail?
  feedback      feedback[]
  orders        orders[]
  promotion_usage promotion_usage[] @relation("UserPromotionUsage")
  blogs         blogs[]              // Relation với bảng blogs
  roles         roles                @relation(fields: [role_id], references: [role_id], onDelete: NoAction, onUpdate: NoAction, map: "users_ibfk_1")

  @@index([role_id], map: "role_id")
}


model point_history {
  id         Int      @id @default(autoincrement())
  user_id    Int
  change     Int // + hoặc - điểm
  reason     String?  @db.VarChar(255) // ví dụ: "đổi quà", "hoàn thành đơn hàng"
  created_at DateTime @default(now())

  users users @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
}

model staff_detail {
  staff_id  Int      @id @default(autoincrement())
  user_id   Int      @unique
  position  String   @db.VarChar(100)
  hire_date DateTime @default(now()) // ngày vào làm
  salary    Int?
  shift     String?  @db.VarChar(50) //ca làm 

  users users @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
}

model blogs {
  blog_id       String   @id @default(uuid())
  title         String   @db.VarChar(255)
  slug          String   @unique @db.VarChar(255)
  description   String?  @db.VarChar(500)
  content       String   @db.Text
  thumbnail     String?  @db.VarChar(255)

  // Loại và trạng thái bài viết
  type          BlogType   @default(NEWS)
  status        BlogStatus @default(DRAFT)

  created_at    DateTime   @default(now())
  updated_at    DateTime   @updatedAt
  published_at  DateTime?

  // Người viết
  author_id     Int
  author        users      @relation(fields: [author_id], references: [user_id], onDelete: Cascade)

  // SEO cơ bản
  meta_title       String?  @db.VarChar(255)
  meta_description String?  @db.VarChar(500)

  // Thống kê
  view_count     Int        @default(0)

  @@index([author_id])
  @@index([type])
  @@index([status])
  @@index([slug])
}

enum BlogType {
  NEWS
  PROMOTION
  PRODUCT
  EVENT
  GUIDE
}

enum BlogStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}




enum membership_level {
  BRONZE
  SILVER
  GOLD
  DIAMOND
}

enum inventory_change_type {
  import
  export
  adjustment
}


enum product_size {
  M
  L
  XL
  DEFAULT
}


enum order_status_history_status {
  pending
  ready
  shipped
  completed
  canceled
}

enum payment_method {
  cod
  banking
  momo
  paypal
}

enum payment_status {
  pending
  success
  failed
}

enum user_status {
  ACTIVE
  LOCKED
}

enum orders_status {
  pending
  ready
  shipped
  completed
  canceled
}

enum users_auth_provider {
  system
  google
  facebook
  apple
}

enum OrderType {
  DINE_IN      // tại quán, khách uống tại chỗ
  TAKE_AWAY    // mang đi
  DELIVERY     // giao hàng
}

enum OrderSource {
  STAFF        // nhân viên tạo tại quầy
  CUSTOMER     // khách tự đặt online
}