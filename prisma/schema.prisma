// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "fullTextIndex"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model cart {
  cart_id      Int            @id @default(autoincrement())
  user_id      Int            @unique
  total        Int
  quantity     Int
  users        users          @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction, map: "cart_ibfk_1")
  cart_details cart_details[]

  @@index([user_id], map: "user_id")
}

model cart_details {
  cart_detail_id Int          @id @default(autoincrement())
  cart_id        Int
  product_id     Int
  product_size   product_size
  quantity       Int
  price          Int
  cart           cart         @relation(fields: [cart_id], references: [cart_id], onDelete: NoAction, onUpdate: NoAction, map: "cart_details_ibfk_1")
  products       products     @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction, map: "cart_details_ibfk_2")

  @@index([cart_id], map: "cart_id")
  @@index([product_id], map: "product_id")
}

model categories {
  category_id Int        @id @default(autoincrement())
  name        String     @db.VarChar(100)
  description String?    @db.VarChar(255)
  images      String?    @db.VarChar(255)
  products    products[]
  created_at  DateTime?  @default(now()) @db.DateTime(0)
  deleted_at  DateTime?
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model feedback {
  id         Int      @id @default(autoincrement())
  user_id    Int
  product_id Int
  created_at DateTime @default(now()) @db.DateTime(0)
  rating     Int
  images     Json?
  comment    String?  @db.VarChar(255)
  users      users    @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction, map: "feedback_ibfk_1")
  products   products @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction, map: "feedback_ibfk_2")

  @@index([product_id], map: "product_id")
  @@index([user_id], map: "user_id")
}

model inventory {
  inventory_id Int                   @id @default(autoincrement())
  product_id   Int
  change_type  inventory_change_type
  quantity     Int
  created_at   DateTime              @default(now()) @db.DateTime(0)
  products     products              @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction, map: "inventory_ibfk_1")

  @@index([product_id], map: "product_id")
}

model order_details {
  order_detail_id Int      @id @default(autoincrement())
  order_id        String
  product_id      Int
  quantity        Int
  size            String?  @db.VarChar(20)
  price           Decimal  @db.Decimal(10, 2)
  orders          orders   @relation(fields: [order_id], references: [order_id], onDelete: NoAction, onUpdate: NoAction, map: "order_details_ibfk_1")
  products        products @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction, map: "order_details_ibfk_2")

  @@index([order_id], map: "order_id")
  @@index([product_id], map: "product_id")
}

model order_status_history {
  order_status_history_id Int                         @id @default(autoincrement())
  order_id                String                      @db.VarChar(50)
  status                  order_status_history_status
  changed_at              DateTime                    @default(now()) @db.DateTime(0)
  orders                  orders                      @relation(fields: [order_id], references: [order_id], onDelete: NoAction, onUpdate: NoAction, map: "order_status_history_ibfk_1")

  @@index([order_id], map: "order_id")
}

model orders {
  order_id         String        @id @db.VarChar(50)
  user_id          Int?
  orderDate        DateTime      @default(now()) @db.DateTime(0)
  status           orders_status @default(pending)
  delivery_address String        @db.VarChar(255)
  receiver_name    String        @db.VarChar(100)
  receiver_phone   String        @db.VarChar(20)

  order_details        order_details[]
  order_status_history order_status_history[]
  users                users?                 @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction, map: "orders_ibfk_1")
  // staff                staff_detail?          @relation(fields: [staff_id], references: [staff_id], onDelete: Cascade, onUpdate: NoAction)

  payment      payment[]
  order_type   OrderType   @default(DINE_IN)
  order_source OrderSource @default(STAFF)

  promotion_id    Int?
  original_amount Decimal @db.Decimal(10, 2) // Giá gốc
  discount_amount Decimal @default(0) @db.Decimal(10, 2) // Tiền giảm
  final_amount    Decimal @db.Decimal(10, 2) // Giá cuối = original - discount

  promotion_usage promotion_usage[]

  @@index([user_id], map: "user_id")
}

model payment {
  payment_id       Int            @id @default(autoincrement())
  order_id         String         @db.VarChar(50)
  method           payment_method
  status           payment_status @default(pending)
  total_amount     Int
  transaction_date DateTime       @default(now()) @db.DateTime(0)
  orders           orders         @relation(fields: [order_id], references: [order_id], onDelete: NoAction, onUpdate: NoAction, map: "payment_ibfk_1")

  @@index([order_id], map: "order_id")
}

model products {
  product_id         Int                  @id @default(autoincrement())
  name               String               @db.VarChar(255)
  description        String?              @db.VarChar(255)
  sold               Int                  @default(0)
  category_id        Int?
  average_rating     Int                  @default(0)
  images             String?              @db.VarChar(255)
  quantity           Int                  @default(-1)
  status             ProductStatus        @default(DANG_BAN)
  createdAt          DateTime             @default(now())
  cart_details       cart_details[]
  feedback           feedback[]
  inventory          inventory[]
  order_details      order_details[]
  categories         categories?          @relation(fields: [category_id], references: [category_id], onDelete: NoAction, onUpdate: NoAction, map: "products_ibfk_1")
  promotion_products promotion_products[]
  price_product      price_product[]
  favorites          favorite[]

  @@index([category_id], map: "category_id")
}

model price_product {
  price_product_id Int           @id @default(autoincrement())
  product_id       Int
  size             product_size?
  price            Int

  products products @relation(fields: [product_id], references: [product_id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([product_id, size], map: "product_size_unique")
  @@index([product_id], map: "product_id_idx")
}

model promotion_products {
  promotion_product_id String     @id @default(uuid())
  promotion_id         String
  product_id           Int
  size                 String?    @db.VarChar(10)
  promotions           promotions @relation(fields: [promotion_id], references: [promotion_id], onDelete: NoAction, onUpdate: NoAction, map: "promotion_products_ibfk_1")
  products             products   @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction, map: "promotion_products_ibfk_2")

  @@index([product_id], map: "product_id")
  @@index([promotion_id], map: "promotion_id")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model promotions {
  promotion_id          String        @id
  code                  String?       @unique(map: "code") @db.VarChar(50)
  description           String?       @db.VarChar(255)
  discount_percent      Decimal?      @db.Decimal(5, 2)
  discount_price        Int?          @default(0)
  start_date            DateTime      @db.DateTime(0)
  end_date              DateTime      @db.DateTime(0)
  type                  PromotionType @default(voucher)
  //Điều kiện áp dụng
  min_order_amount      Decimal?      @db.Decimal(10, 2) // Đơn tối thiểu
  max_usage_count       Int? // Số lần dùng giới hạn (null = không giới hạn)
  current_usage         Int           @default(0) // Đã dùng bao nhiêu lần
  is_for_new_user       Boolean       @default(false) // Chỉ dùng cho KH mới?
  applicable_membership Json?

  is_active Boolean @default(true)

  promotion_products promotion_products[]
  promotion_usage    promotion_usage[]
}

model promotion_usage {
  usage_id     Int      @id @default(autoincrement())
  promotion_id String
  order_id     String
  user_id      Int?
  user_phone   String?  @db.VarChar(20)
  used_at      DateTime @default(now()) @db.DateTime(0)

  promotions promotions @relation(fields: [promotion_id], references: [promotion_id], onDelete: NoAction)
  orders     orders     @relation(fields: [order_id], references: [order_id], onDelete: NoAction)
  users      users?     @relation("UserPromotionUsage", fields: [user_id], references: [user_id], onDelete: NoAction)

  @@unique([promotion_id, user_id])
  @@index([promotion_id])
  @@index([order_id])
  @@index([user_id])
}

model roles {
  role_id     Int     @id @default(autoincrement())
  name        String  @db.VarChar(50)
  description String  @db.VarChar(255)
  users       users[]
}

model users {
  user_id            Int                  @id @default(autoincrement())
  email              String               @unique(map: "email") @db.VarChar(255)
  username           String               @db.VarChar(255)
  password           String               @db.VarChar(255)
  phone              String?              @unique(map: "phone") @db.VarChar(255)
  address            String?              @db.VarChar(255)
  avatar             String?              @db.VarChar(255)
  gender             String?              @db.VarChar(45)
  birthday           DateTime?
  status             user_status          @default(ACTIVE)
  point              Int?                 @default(0)
  role_id            Int
  reset_token        String?              @db.VarChar(255)
  reset_token_expire DateTime?            @db.DateTime(0)
  auth_provider      users_auth_provider? @default(system)

  membership      membership_level?
  discount_rate   Int?              @default(0)
  cart            cart[]
  point_history   point_history[]
  staff_detail    staff_detail?
  feedback        feedback[]
  orders          orders[]
  promotion_usage promotion_usage[] @relation("UserPromotionUsage")

  messages  Message[]  @relation("UserMessages")
  userRooms UserRoom[]
  roles     roles      @relation(fields: [role_id], references: [role_id], onDelete: NoAction, onUpdate: NoAction, map: "users_ibfk_1")
  favorites favorite[]

  @@index([role_id], map: "role_id")
  @@fulltext([username, email])
}

model Room {
  id        Int        @id @default(autoincrement())
  name      String?
  isPrivate Boolean    @default(true)
  createdAt DateTime   @default(now())
  messages  Message[]
  userRooms UserRoom[]
}

model UserRoom {
  id       Int      @id @default(autoincrement())
  userId   Int
  user     users    @relation(fields: [userId], references: [user_id])
  room     Room     @relation(fields: [roomId], references: [id])
  roomId   Int
  joinedAt DateTime @default(now())

  @@unique([userId, roomId])
}

model Message {
  id        Int      @id @default(autoincrement())
  room      Room     @relation(fields: [roomId], references: [id])
  roomId    Int
  sender    users    @relation("UserMessages", fields: [senderId], references: [user_id])
  senderId  Int
  content   String
  meta      Json? // dùng để lưu kiểu file, status..., optional
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}

model point_history {
  id         Int      @id @default(autoincrement())
  user_id    Int
  change     Int // + hoặc - điểm
  reason     String?  @db.VarChar(255) // ví dụ: "đổi quà", "hoàn thành đơn hàng"
  created_at DateTime @default(now())

  users users @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
}

model favorite {
  favorite_id Int      @id @default(autoincrement())
  user        users    @relation(fields: [userId], references: [user_id])
  userId      Int
  product     products @relation(fields: [productId], references: [product_id])
  productId   Int
  createdAt   DateTime @default(now())

  @@unique([userId, productId]) // tránh trùng
}

model staff_detail {
  staff_id  Int      @id @default(autoincrement())
  user_id   Int      @unique
  position  String   @db.VarChar(100)
  hire_date DateTime @default(now()) // ngày vào làm
  salary    Int?

  users           users             @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  staff_schedules staff_schedules[]

  @@index([user_id])
}

model work_shifts {
  shift_id Int    @id @default(autoincrement())
  name     String @unique @db.VarChar(100) // Ví dụ: "Sáng (7h-15h)", "Chiều (14h-22h)"

  staff_schedules staff_schedules[]
}

model staff_schedules {
  staff_schedule_id Int             @id @default(autoincrement())
  staff_id          Int
  day_of_week       Int
  shift_id          Int?
  status            schedule_status @default(WORK)

  staff_detail staff_detail @relation(fields: [staff_id], references: [staff_id], onDelete: Cascade)
  work_shifts  work_shifts? @relation(fields: [shift_id], references: [shift_id])

  @@unique([staff_id, day_of_week])
  @@index([staff_id])
  @@index([shift_id])
}

enum membership_level {
  BRONZE
  SILVER
  GOLD
  DIAMOND
}

enum inventory_change_type {
  import
  export
  adjustment
}

enum product_size {
  M
  L
  XL
  DEFAULT
}

enum order_status_history_status {
  pending
  ready
  shipped
  completed
  canceled
}

enum payment_method {
  cod
  banking
  momo
  paypal
}

enum payment_status {
  pending
  success
  failed
}

enum user_status {
  ACTIVE
  LOCKED
}

enum orders_status {
  pending
  ready
  shipped
  completed
  canceled
}

enum OrderType {
  DINE_IN // tại quán, khách uống tại chỗ
  TAKE_AWAY // mang đi
  DELIVERY // giao hàng
}

enum OrderSource {
  STAFF // nhân viên tạo tại quầy
  CUSTOMER // khách tự đặt online
}

enum users_auth_provider {
  system
  google
  facebook
  apple
}

enum ProductStatus {
  DANG_BAN // đang bán
  HET // hết hàng
  TAM_AN // tạm ẩn
}

enum schedule_status {
  WORK
  OFF
}

enum PromotionType {
  voucher
  flashsale
}
